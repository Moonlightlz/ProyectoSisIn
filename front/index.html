<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inteligente - Gestión de Pagos</title>
    <link rel="stylesheet" href="app.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://unpkg.com/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://unpkg.com/jwt-decode@3.1.2/build/jwt-decode.js"></script>
    <script src="https://unpkg.com/chart.js@4.3.0/dist/chart.min.js"></script>
    <script src="https://unpkg.com/react-chartjs-2@5.2.0/dist/index.umd.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Componente de Login
        function Login({ setToken }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const response = await axios.post('http://127.0.0.1:8000/api/token/', {
                        username,
                        password
                    });
                    setToken(response.data);
                } catch (err) {
                    setError('Credenciales incorrectas. Inténtalo de nuevo.');
                }
            };

            return (
                <div className="login-wrapper">
                    <h1>Iniciar Sesión</h1>
                    <form onSubmit={handleSubmit}>
                        <label>
                            <p>Usuario</p>
                            <input 
                                type="text" 
                                value={username}
                                onChange={e => setUsername(e.target.value)} 
                            />
                        </label>
                        <label>
                            <p>Contraseña</p>
                            <input 
                                type="password" 
                                value={password}
                                onChange={e => setPassword(e.target.value)} 
                            />
                        </label>
                        {error && <p className="error">{error}</p>}
                        <div>
                            <button type="submit">Entrar</button>
                        </div>
                    </form>
                </div>
            );
        }

        // Componente Dashboard de Usuario
        function UserDashboard({ token }) {
            const [productos, setProductos] = useState([]);

            useEffect(() => {
                if (token && token.access) {
                    axios.get('http://127.0.0.1:8000/api/productos/', {
                        headers: {
                            'Authorization': `Bearer ${token.access}`
                        }
                    })
                    .then(res => {
                        setProductos(res.data);
                    })
                    .catch(err => {
                        console.error("Error al obtener productos:", err);
                    });
                }
            }, [token]);

            const handleAdquirir = (productoId) => {
                axios.post('http://127.0.0.1:8000/api/pedidos/', 
                    {
                        producto: productoId,
                    }, 
                    {
                        headers: { 'Authorization': `Bearer ${token.access}` }
                    }
                )
                .then(response => {
                    alert('¡Pedido realizado con éxito!');
                })
                .catch(error => {
                    alert('Hubo un error al realizar el pedido.');
                    console.error('Error en el pedido:', error);
                });
            };

            return (
                <div>
                    <h1>Catálogo de Productos</h1>
                    <div className="product-list">
                        {productos.map(prod => (
                            <div key={prod.id} className="product-card">
                                <h3>{prod.nombre}</h3>
                                <p>{prod.descripcion}</p>
                                <p className="price">S/ {prod.precio}</p>
                                <button onClick={() => handleAdquirir(prod.id)}>
                                    Adquirir
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Componente Dashboard de Admin
        function AdminDashboard({ token }) {
            const [clientes, setClientes] = useState([]);
            const [pedidos, setPedidos] = useState([]);

            useEffect(() => {
                const authHeaders = { headers: { 'Authorization': `Bearer ${token.access}` } };
                
                // Obtener clientes
                axios.get('http://127.0.0.1:8000/api/clientes/', authHeaders)
                    .then(res => setClientes(res.data))
                    .catch(err => console.error("Error obteniendo clientes:", err));

                // Obtener pedidos
                axios.get('http://127.0.0.1:8000/api/pedidos/', authHeaders)
                    .then(res => setPedidos(res.data))
                    .catch(err => console.error("Error obteniendo pedidos:", err));
            }, [token]);

            return (
                <div>
                    <h1>Panel de Administrador</h1>
                    
                    <div className="admin-section">
                        <h2>Clientes</h2>
                        <div className="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Empresa</th>
                                        <th>Estado de Pago</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {clientes.map(cliente => (
                                        <tr key={cliente.id}>
                                            <td>{cliente.nombre_completo}</td>
                                            <td>{cliente.empresa}</td>
                                            <td className={`status-${cliente.estado_pago.toLowerCase()}`}>
                                                {cliente.estado_pago}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="admin-section">
                        <h2>Pedidos Recientes</h2>
                        <div className="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {pedidos.map(pedido => (
                                        <tr key={pedido.id}>
                                            <td>{pedido.cliente_nombre}</td>
                                            <td>{pedido.producto_nombre}</td>
                                            <td>{pedido.cantidad}</td>
                                            <td>{new Date(pedido.fecha_pedido).toLocaleDateString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // Componente Principal
        function App() {
            const [token, setToken] = useState(null);

            const handleLogout = () => {
                setToken(null);
            };

            if (!token) {
                return <Login setToken={setToken} />;
            }

            // Decodificar el token para determinar si es admin
            const decodedToken = jwt_decode(token.access);
            const isAdmin = decodedToken.user_id === 1; // Asumiendo que el admin tiene ID 1

            return (
                <div className="App">
                    <div className="header">
                        <h1>Mi Sistema Inteligente</h1>
                        <button onClick={handleLogout} className="logout-button">
                            Cerrar Sesión
                        </button>
                    </div>

                    {isAdmin 
                        ? <AdminDashboard token={token} /> 
                        : <UserDashboard token={token} />
                    }
                </div>
            );
        }

        // Renderizar la aplicación
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>